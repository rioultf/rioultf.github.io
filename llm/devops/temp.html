<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="François Rioult" />
  <title>Application des LLM</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; } /* Alert */
    code span.an { color: #008000; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #0000ff; } /* ControlFlow */
    code span.ch { color: #008080; } /* Char */
    code span.cn { } /* Constant */
    code span.co { color: #008000; } /* Comment */
    code span.cv { color: #008000; } /* CommentVar */
    code span.do { color: #008000; } /* Documentation */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.im { } /* Import */
    code span.in { color: #008000; } /* Information */
    code span.kw { color: #0000ff; } /* Keyword */
    code span.op { } /* Operator */
    code span.ot { color: #ff4000; } /* Other */
    code span.pp { color: #ff4000; } /* Preprocessor */
    code span.sc { color: #008080; } /* SpecialChar */
    code span.ss { color: #008080; } /* SpecialString */
    code span.st { color: #008080; } /* String */
    code span.va { } /* Variable */
    code span.vs { color: #008080; } /* VerbatimString */
    code span.wa { color: #008000; font-weight: bold; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Application des LLM</h1>
<p class="subtitle">Introduction</p>
<p class="author">François Rioult</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#compréhension-de-loutil-au-sens-de-open-webui"><span class="toc-section-number">2</span> Compréhension de l’outil au sens de <code>Open-webui</code></a>
<ul>
<li><a href="#outils-de-lapi-dopenai"><span class="toc-section-number">2.1</span> Outils de l’API d’OpenAI</a></li>
<li><a href="#outils-au-sens-de-open-webui"><span class="toc-section-number">2.2</span> Outils au sens de <code>Open-webui</code></a>
<ul>
<li><a href="#choix-de-loutil"><span class="toc-section-number">2.2.1</span> Choix de l’outil</a></li>
<li><a href="#formulation-de-la-réponse"><span class="toc-section-number">2.2.2</span> Formulation de la réponse</a></li>
</ul></li>
</ul></li>
<li><a href="#discussion"><span class="toc-section-number">3</span> Discussion</a></li>
<li><a href="#difficultés"><span class="toc-section-number">4</span> Difficultés</a></li>
<li><a href="#ce-que-je-recommande"><span class="toc-section-number">5</span> Ce que je recommande</a></li>
<li><a href="#pré-recquis"><span class="toc-section-number">6</span> Pré-recquis</a>
<ul>
<li><a href="#choix-du-modèle"><span class="toc-section-number">6.1</span> Choix du modèle</a></li>
<li><a href="#lancement-de-lapplication"><span class="toc-section-number">6.2</span> Lancement de l’application</a></li>
<li><a href="#dans-la-console-du-navigateur"><span class="toc-section-number">6.3</span> Dans la console du navigateur</a></li>
</ul></li>
<li><a href="#conclusion"><span class="toc-section-number">7</span> Conclusion</a>
<ul>
<li><a href="#leçons"><span class="toc-section-number">7.1</span> Leçons</a></li>
</ul></li>
<li><a href="#questions"><span class="toc-section-number">8</span> Questions</a></li>
<li><a href="#pensée"><span class="toc-section-number">9</span> Pensée</a></li>
<li><a href="#sources"><span class="toc-section-number">10</span> Sources</a></li>
</ul>
</nav>
<p>Ce document synthétise mes déboires et succès dans l’exécution d’<em>outils</em> avec <code>OWUI</code> (a.k.a <a href="https://docs.openwebui.com/">Open-webui</a>).</p>
<h1 data-number="1" id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<p><code>Open-webui</code> fait tourner un serveur local et rend disponible une interface web pour concevoir des <em>applications</em> à base de LLM. C’est un outil libre et open-source, développé par une seule personne, pourtant la qualité est extraordinaire :</p>
<ul>
<li>l’interface pour la mise au point des prompts est la plus complète que j’aie vue : les interactions sont stockées dans un arbre ; c’est un <em>historique arborescent</em></li>
<li>tout ce qui est nécessaire au RAG et la compétition de modèles est intégré</li>
<li>des <em>filtres</em>, qui modifient le prompt et la réponse</li>
<li>des <em>actions</em>, qui ajoutent des fonctionnalités à l’interface de saisie du prompt : en plus des traditionnels copy/vote, on peut déclencher du code, qui interprète la réponse du modèle pour e.g. générer des graphiques</li>
<li>des <em>outils</em>, écrits en python, sous forme de fonctions bien documentées, sont soumises avec le prompt au modèle, qui indique quelle fonction appeler, et avec quels paramètres.</li>
</ul>
<p>Une <em>application</em> réalisée avec <code>Open-webui</code> est donc un chatbot qui interroge et manipule les réponses de tout type de modèle, avec du code.</p>
<p>La promesse est forte d’aller vers la réalisation mais la mise en oeuvre est rude : il manque à <code>Open-webui</code> les éléments d’information permettant de maîtriser ce qui se produit exactement. Même si la documentation est bien détaillée, les aspects de contrôle, autour du log, sont plutôt inacessibles.</p>
<p>Ci-dessous, une tentative de d’explications sur le déroulement d’un outil personnalisé.</p>
<h1 data-number="2" id="compréhension-de-loutil-au-sens-de-open-webui"><span class="header-section-number">2</span> Compréhension de l’outil au sens de <code>Open-webui</code></h1>
<h2 data-number="2.1" id="outils-de-lapi-dopenai"><span class="header-section-number">2.1</span> Outils de l’API d’OpenAI</h2>
<p>OpenAI a défini une syntaxe de requêtes pour demander au modèle de choisir un outils. On assemble une requête sur API comme suit :</p>
<ul>
<li>liste des outils <code>tools.json</code></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ot">[</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>    <span class="fu">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>        <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;function&quot;</span><span class="fu">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>        <span class="dt">&quot;function&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>            <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;get_current_weather&quot;</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>            <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Get the current weather, in particular the temperature, at a given location&quot;</span><span class="fu">,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>            <span class="dt">&quot;parameters&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>                <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;object&quot;</span><span class="fu">,</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>                <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>                    <span class="dt">&quot;location&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>                        <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;string&quot;</span><span class="fu">,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>                        <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;The city and state, e.g. San Francisco, CA&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>                    <span class="fu">}</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>                <span class="fu">},</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>                <span class="dt">&quot;required&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>                    <span class="st">&quot;location&quot;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>                <span class="ot">]</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>            <span class="fu">}</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a>        <span class="fu">}</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a>    <span class="er">...</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a><span class="ot">]</span></span></code></pre></div>
<ul>
<li>assemblage de la requête</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="va">MODEL=</span><span class="st">&#39;smollm2:1.7b&#39;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="va">tools=</span>tools.json</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="va">messages=</span><span class="st">&#39;[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is the temperature at the location 51.5074/-0.1278?&quot;}]&#39;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="va">cmd=</span><span class="st">&quot;curl http://localhost:11434/v1/chat/completions \</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="st">  -H </span><span class="dt">\&quot;</span><span class="st">Content-Type: application/json</span><span class="dt">\&quot;</span><span class="st"> \</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="st">  -d &#39;{</span><span class="dt">\&quot;</span><span class="st">model</span><span class="dt">\&quot;</span><span class="st">: </span><span class="dt">\&quot;</span><span class="va">$MODEL</span><span class="dt">\&quot;</span><span class="st">, </span><span class="dt">\&quot;</span><span class="st">messages</span><span class="dt">\&quot;</span><span class="st">: </span><span class="va">$messages</span><span class="st">, </span><span class="dt">\&quot;</span><span class="st">tools</span><span class="dt">\&quot;</span><span class="st">: </span><span class="va">$(</span><span class="ex">jq</span> . <span class="va">$tools)</span><span class="st">}&#39;&quot;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="bu">echo</span> <span class="va">$cmd</span> <span class="op">&gt;&amp;2</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="bu">eval</span> <span class="va">$cmd</span></span></code></pre></div>
<ul>
<li>la réponse est</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;chatcmpl-667&quot;</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  <span class="dt">&quot;object&quot;</span><span class="fu">:</span> <span class="st">&quot;chat.completion&quot;</span><span class="fu">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>  <span class="dt">&quot;created&quot;</span><span class="fu">:</span> <span class="dv">1736950622</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  <span class="dt">&quot;model&quot;</span><span class="fu">:</span> <span class="st">&quot;smollm2:1.7b&quot;</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>  <span class="dt">&quot;system_fingerprint&quot;</span><span class="fu">:</span> <span class="st">&quot;fp_ollama&quot;</span><span class="fu">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>  <span class="dt">&quot;choices&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>    <span class="fu">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>      <span class="dt">&quot;index&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>      <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>        <span class="dt">&quot;role&quot;</span><span class="fu">:</span> <span class="st">&quot;assistant&quot;</span><span class="fu">,</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>        <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>        <span class="dt">&quot;tool_calls&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>          <span class="fu">{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>            <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;call_ivphnztl&quot;</span><span class="fu">,</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>            <span class="dt">&quot;index&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;function&quot;</span><span class="fu">,</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>            <span class="dt">&quot;function&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>              <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;get_current_weather&quot;</span><span class="fu">,</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>              <span class="dt">&quot;arguments&quot;</span><span class="fu">:</span> <span class="st">&quot;{</span><span class="ch">\&quot;</span><span class="st">location</span><span class="ch">\&quot;</span><span class="st">:</span><span class="ch">\&quot;</span><span class="st">-0.1278,51.5074</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">temperature</span><span class="ch">\&quot;</span><span class="st">:12}&quot;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>            <span class="fu">}</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>          <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>          <span class="fu">{</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>            <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;call_qyx6dy9j&quot;</span><span class="fu">,</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>            <span class="dt">&quot;index&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;function&quot;</span><span class="fu">,</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>            <span class="dt">&quot;function&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a>              <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;get_current_weather&quot;</span><span class="fu">,</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a>              <span class="dt">&quot;arguments&quot;</span><span class="fu">:</span> <span class="st">&quot;{</span><span class="ch">\&quot;</span><span class="st">location</span><span class="ch">\&quot;</span><span class="st">:</span><span class="ch">\&quot;</span><span class="st">-0.1278,51.5074</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">temperature</span><span class="ch">\&quot;</span><span class="st">:6}&quot;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a>            <span class="fu">}</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a>          <span class="fu">}</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a>        <span class="ot">]</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a>      <span class="fu">},</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true"></a>      <span class="dt">&quot;finish_reason&quot;</span><span class="fu">:</span> <span class="st">&quot;tool_calls&quot;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true"></a>    <span class="fu">}</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true"></a>  <span class="dt">&quot;usage&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true"></a>    <span class="dt">&quot;prompt_tokens&quot;</span><span class="fu">:</span> <span class="dv">451</span><span class="fu">,</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true"></a>    <span class="dt">&quot;completion_tokens&quot;</span><span class="fu">:</span> <span class="dv">91</span><span class="fu">,</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true"></a>    <span class="dt">&quot;total_tokens&quot;</span><span class="fu">:</span> <span class="dv">542</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true"></a>  <span class="fu">}</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true"></a><span class="fu">}</span></span></code></pre></div>
<p>On constate que même des modèles légers s’en sortent bien.</p>
<h2 data-number="2.2" id="outils-au-sens-de-open-webui"><span class="header-section-number">2.2</span> Outils au sens de <code>Open-webui</code></h2>
<p>Pour <code>Open-webui</code>, l’utilisation d’un outil se passe en deux temps :</p>
<ol type="1">
<li>interrogation du modèle pour choisir l’outil à appeler</li>
<li>interrogation du modèle avec le résultat de l’exécution de la fonction Python de l’outil</li>
</ol>
<h3 data-number="2.2.1" id="choix-de-loutil"><span class="header-section-number">2.2.1</span> Choix de l’outil</h3>
<ul>
<li><p>le prompt</p>
<pre><code>  what is the height of the water on sensor 1?</code></pre></li>
<li><p>la liste des outils et leur description</p></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    <span class="dt">&quot;get_current_water_level&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>        <span class="dt">&quot;toolkit_id&quot;</span><span class="fu">:</span> <span class="st">&quot;toolbox&quot;</span><span class="fu">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>        <span class="dt">&quot;callable&quot;</span><span class="fu">:</span> <span class="er">&lt;function</span> <span class="er">Tools.get_current_water_level</span> <span class="er">at</span> <span class="dv">0</span><span class="er">x7fea0c082fc0&gt;</span><span class="fu">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>        <span class="dt">&quot;spec&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>            <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;get_current_water_level&quot;</span><span class="fu">,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>            <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Get the current water level of a specific sensor.&quot;</span><span class="fu">,</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>            <span class="dt">&quot;parameters&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>                <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>                    <span class="dt">&quot;sensor_number&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>                        <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;The sensor number of which should be used to measure the water level.&quot;</span><span class="fu">,</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>                        <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;string&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>                    <span class="fu">}</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>                <span class="fu">},</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>                <span class="dt">&quot;required&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a>                    <span class="st">&quot;sensor_number&quot;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>                <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a>                <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;object&quot;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>            <span class="fu">}</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a>        <span class="fu">},</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a>        <span class="dt">&quot;pydantic_model&quot;</span><span class="fu">:</span> <span class="er">&lt;class</span> <span class="st">&quot;open_webui.utils.tools.get_current_water_level&quot;</span><span class="er">&gt;</span><span class="fu">,</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a>        <span class="dt">&quot;file_handler&quot;</span><span class="fu">:</span> <span class="er">False</span><span class="fu">,</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a>        <span class="dt">&quot;citation&quot;</span><span class="fu">:</span> <span class="er">True</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a>    <span class="fu">}</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a><span class="fu">}</span></span></code></pre></div>
<ul>
<li><p>et on lui demande :</p>
<pre><code>  Return an empty string if no tools match the query. If a function tool matches, construct and return a JSON object in the format {&quot;name&quot;: &quot;functionName&quot;, &quot;parameters&quot;: {&quot;requiredFunctionParamKey&quot;: &quot;requiredFunctionParamValue&quot;}} using the appropriate tool and its parameters. Only return the object and limit the response to the JSON object without additional text.</code></pre></li>
<li><p>le modèle retourne</p>
<pre><code>  DEBUG [open_webui.utils.middleware] content=&#39;{&quot;name&quot;:&quot;get_current_water_level&quot;,&quot;parameters&quot;:{&quot;sensor_number&quot;:&quot;1&quot;}}&#39;</code></pre></li>
</ul>
<h3 data-number="2.2.2" id="formulation-de-la-réponse"><span class="header-section-number">2.2.2</span> Formulation de la réponse</h3>
<p>Le modèle va être interrogé une seconde fois avec le résultat de la fonction Python, appelée avec son paramètre :</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>    <span class="kw">def</span> get_current_water_level(<span class="va">self</span>, sensor_number: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="co">        Get the current water level of a specific sensor.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="co">        :param sensor_number: The sensor number of which should be used to measure the water level.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a><span class="co">        :return: The current water level of given sensor.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>        <span class="cf">if</span> sensor_number <span class="op">==</span> <span class="st">&quot;1&quot;</span>:</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>            water_level <span class="op">=</span> <span class="st">&quot;1.35 mm&quot;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>        <span class="cf">elif</span> sensor_number <span class="op">==</span> <span class="st">&quot;2&quot;</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>            water_level <span class="op">=</span> <span class="st">&quot;0.54 mm&quot;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>            water_level <span class="op">=</span> <span class="st">&quot;not applicable&quot;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a>        <span class="cf">return</span> <span class="ss">f&quot;Answer in french that the current water level of sensor </span><span class="sc">{</span>sensor_number<span class="sc">}</span><span class="ss"> is </span><span class="sc">{</span>water_level<span class="sc">}</span><span class="ss">.&quot;</span></span></code></pre></div>
<p>La réponse finale est la réponse au prompt</p>
<pre><code>    Answer in french that the current water level of sensor 1 is 1.35 mm</code></pre>
<p>soit</p>
<pre><code>    La hauteur actuelle de l&#39;eau sur le capteur 1 est de 1,35 mm [source_id].</code></pre>
<p>Sur cette image, j’ai eu <code>[source_id]</code> en retour. Aucune indication de l’appel de l’outil. <img src="fig/sensor1.png"></p>
<p>Parfois j’ai la chance d’avoir une indication de l’appel de l’outil : <img src="fig/sensor2.png"></p>
<p>On me dit que <a href="https://github.com/open-webui/open-webui/discussions/3134#discussioncomment-11218580">pour avoir le bouton</a> il faut déclarer :</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">class</span> Tools:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>        <span class="va">self</span>.citation <span class="op">=</span> <span class="va">True</span></span></code></pre></div>
<h1 data-number="3" id="discussion"><span class="header-section-number">3</span> Discussion</h1>
<p>Pour identifier clairement le comportement d’un outil, il importe de fournir au modèle :</p>
<ul>
<li>des questions auquelles seul l’outil peut répondre. Le problème c’est que le modèle est très performant et peut</li>
</ul>
<h1 data-number="4" id="difficultés"><span class="header-section-number">4</span> Difficultés</h1>
<p>Il est extrèmement difficile de mettre en place un processus fiable de développement avec <code>Open-webui</code>, car on ne sait pas facilement si l’outil s’est ou non déclenché. De plus,</p>
<ul>
<li>les logs sont sporadiques dans la console web</li>
<li>les logs</li>
<li>parfois j’ai un bouton, et parfois il me donne une pop-up avec le résultat de l’appel de la fonction Python</li>
</ul>
<h1 data-number="5" id="ce-que-je-recommande"><span class="header-section-number">5</span> Ce que je recommande</h1>
<ul>
<li>il faut un modèle très costaud pour interpréter le prompt de sélection d’outil, j’utilise <code>gtp-4o-mini</code>. C’est un peu du luxe. Gemma-2B semblait prometteur.</li>
<li>il faut lancer le serveur et stocker sa sortie standard, qui peut être analysée et filtrée</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="ex">open-webui</span> serve <span class="kw">|</span> <span class="fu">tee</span> /tmp/log</span></code></pre></div>
<p>And do whatever you like with it:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="fu">tail</span> -f /tmp/log</span></code></pre></div>
<h1 data-number="6" id="pré-recquis"><span class="header-section-number">6</span> Pré-recquis</h1>
<h2 data-number="6.1" id="choix-du-modèle"><span class="header-section-number">6.1</span> Choix du modèle</h2>
<p>Je n’ai pas énormément expérimenté, mais seul <code>gpt-4o-mini</code> s’en sort correctement.</p>
<p>Je travaille avec la version Python : il faut le bon environnement <code>conda</code>.</p>
<h2 data-number="6.2" id="lancement-de-lapplication"><span class="header-section-number">6.2</span> Lancement de l’application</h2>
<p>J’ai préparé toute une batterie de <a href="https://docs.openwebui.com/getting-started/advanced-topics/logging#appbackend">variables de log</a>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a>$ <span class="fu">cat</span> config.sh</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="bu">export</span> <span class="va">AUDIO_LOG_LEVEL=</span>INFO # <span class="va">Audio</span> <span class="va">transcription</span> <span class="va">using</span> <span class="va">faster</span>-whisper, <span class="va">TTS</span> <span class="va">etc</span>.</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a><span class="bu">export</span> <span class="va">COMFYUI_LOG_LEVEL=</span>DEBUG #<span class="va">ComfyUI</span> <span class="va">integration</span> <span class="va">handling</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a><span class="bu">export</span> <span class="va">CONFIG_LOG_LEVEL=</span>DEBUG #<span class="va">Configuration</span> <span class="va">handling</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="bu">export</span> <span class="va">DB_LOG_LEVEL=</span>INFO #  <span class="va">Internal</span> <span class="va">Peewee</span> <span class="va">Database</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a><span class="bu">export</span> <span class="va">IMAGES_LOG_LEVEL=</span>INFO #  <span class="va">AUTOMATIC1111</span> <span class="va">stable</span> <span class="va">diffusion</span> <span class="va">image</span> <span class="va">generation</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a><span class="bu">export</span> <span class="va">MAIN_LOG_LEVEL=</span>DEBUG #   <span class="va">Main</span> (<span class="va">root</span>) <span class="ex">execution</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="bu">export</span> <span class="va">MODELS_LOG_LEVEL=</span>DEBUG # <span class="va">LLM</span> <span class="va">model</span> <span class="va">interaction</span>, <span class="va">authentication</span>, <span class="va">etc</span>.</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a><span class="bu">export</span> <span class="va">OLLAMA_LOG_LEVEL=</span>DEBUG # <span class="va">Ollama</span> <span class="va">backend</span> <span class="va">interaction</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a><span class="bu">export</span> <span class="va">OPENAI_LOG_LEVEL=</span>DEBUG # <span class="va">OpenAI</span> <span class="va">interaction</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a><span class="bu">export</span> <span class="va">RAG_LOG_LEVEL=</span>INFO # <span class="va">Retrieval</span>-Augmented <span class="va">Generation</span> <span class="va">using</span> <span class="va">Chroma</span>/Sentence-Transformers</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a><span class="bu">export</span> <span class="va">WEBHOOK_LOG_LEVEL=</span>INFO # <span class="va">Authentication</span> <span class="va">webhook</span> <span class="va">extended</span> <span class="va">logging</span></span></code></pre></div>
<p>Il faut charger cet environnement et lancer le serveur :</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="bu">source</span> config.sh</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="ex">open-webui</span> serve <span class="kw">|</span> <span class="fu">tee</span> /tmp/log</span></code></pre></div>
<p>Avec la séquence ci-dessus, j’ai obtenu dans la console, les logs suivants, que je commente :</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="co"># user prompt</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>DEBUG [open_webui.utils.middleware] form_data: {<span class="st">&#39;stream&#39;</span>: <span class="va">True</span>, <span class="st">&#39;model&#39;</span>: <span class="st">&#39;with-tools&#39;</span>, <span class="st">&#39;messages&#39;</span>: [{<span class="st">&#39;role&#39;</span>: <span class="st">&#39;user&#39;</span>, <span class="st">&#39;content&#39;</span>: <span class="st">&#39;what is the height of the water on sensor 1?&#39;</span>}], <span class="st">&#39;tool_ids&#39;</span>: [<span class="st">&#39;toolbox&#39;</span>], <span class="st">&#39;features&#39;</span>: {<span class="st">&#39;web_search&#39;</span>: <span class="va">False</span>}, <span class="st">&#39;metadata&#39;</span>: {<span class="st">&#39;user_id&#39;</span>: <span class="st">&#39;2bcc63ca-ea49-461a-9c4b-e7930a2e2b99&#39;</span>, <span class="st">&#39;chat_id&#39;</span>: <span class="st">&#39;0de06587-0cb2-4a1a-bda2-50f5d6a573e4&#39;</span>, <span class="st">&#39;message_id&#39;</span>: <span class="st">&#39;22748f3d-c6d1-4eee-9ee5-7a2d0650233d&#39;</span>, <span class="st">&#39;session_id&#39;</span>: <span class="st">&#39;9oCTk_-_vKFrLVa0AAAB&#39;</span>, <span class="st">&#39;tool_ids&#39;</span>: [<span class="st">&#39;toolbox&#39;</span>], <span class="st">&#39;files&#39;</span>: <span class="va">None</span>, <span class="st">&#39;features&#39;</span>: {<span class="st">&#39;web_search&#39;</span>: <span class="va">False</span>}}}</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="co"># transformation prompt -&gt; inlet par un filtre éventuel</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>INFO  [open_webui.utils.plugin] Loaded module: function_base</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>inlet called: {<span class="st">&#39;stream&#39;</span>: <span class="va">True</span>, <span class="st">&#39;model&#39;</span>: <span class="st">&#39;with-tools&#39;</span>, <span class="st">&#39;messages&#39;</span>: [{<span class="st">&#39;role&#39;</span>: <span class="st">&#39;user&#39;</span>, <span class="st">&#39;content&#39;</span>: <span class="st">&#39;what is the height of the water on sensor 1?&#39;</span>}], <span class="st">&#39;tool_ids&#39;</span>: [<span class="st">&#39;toolbox&#39;</span>], <span class="st">&#39;metadata&#39;</span>: {<span class="st">&#39;user_id&#39;</span>: <span class="st">&#39;2bcc63ca-ea49-461a-9c4b-e7930a2e2b99&#39;</span>, <span class="st">&#39;chat_id&#39;</span>: <span class="st">&#39;0de06587-0cb2-4a1a-bda2-50f5d6a573e4&#39;</span>, <span class="st">&#39;message_id&#39;</span>: <span class="st">&#39;22748f3d-c6d1-4eee-9ee5-7a2d0650233d&#39;</span>, <span class="st">&#39;session_id&#39;</span>: <span class="st">&#39;9oCTk_-_vKFrLVa0AAAB&#39;</span>, <span class="st">&#39;tool_ids&#39;</span>: [<span class="st">&#39;toolbox&#39;</span>], <span class="st">&#39;files&#39;</span>: <span class="va">None</span>, <span class="st">&#39;features&#39;</span>: {<span class="st">&#39;web_search&#39;</span>: <span class="va">False</span>}}}</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>DEBUG [open_webui.utils.middleware] tool_ids<span class="op">=</span>[<span class="st">&#39;toolbox&#39;</span>]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>INFO  [open_webui.utils.plugin] Loaded module: tool_toolbox</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a><span class="co"># Définition des outils disponibles</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>INFO  [open_webui.utils.middleware] tools<span class="op">=</span>{..., <span class="st">&#39;get_current_water_level&#39;</span>: {<span class="st">&#39;toolkit_id&#39;</span>: <span class="st">&#39;toolbox&#39;</span>, <span class="st">&#39;callable&#39;</span>: <span class="op">&lt;</span>function Tools.get_current_water_level at <span class="bn">0x7fea0c082fc0</span><span class="op">&gt;</span>, <span class="st">&#39;spec&#39;</span>: {<span class="st">&#39;name&#39;</span>: <span class="st">&#39;get_current_water_level&#39;</span>, <span class="st">&#39;description&#39;</span>: <span class="st">&#39;Get the current water level of a specific sensor.&#39;</span>, <span class="st">&#39;parameters&#39;</span>: {<span class="st">&#39;properties&#39;</span>: {<span class="st">&#39;sensor_number&#39;</span>: {<span class="st">&#39;description&#39;</span>: <span class="st">&#39;The sensor number of which should be used to measure the water level.&#39;</span>, <span class="st">&#39;type&#39;</span>: <span class="st">&#39;string&#39;</span>}}, <span class="st">&#39;required&#39;</span>: [<span class="st">&#39;sensor_number&#39;</span>], <span class="st">&#39;type&#39;</span>: <span class="st">&#39;object&#39;</span>}}, <span class="st">&#39;pydantic_model&#39;</span>: <span class="op">&lt;</span><span class="kw">class</span> <span class="st">&#39;open_webui.utils.tools.get_current_water_level&#39;</span><span class="op">&gt;</span>, <span class="st">&#39;file_handler&#39;</span>: <span class="va">False</span>, <span class="st">&#39;citation&#39;</span>: <span class="va">True</span>}}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>INFO  [open_webui.utils.middleware] </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a><span class="co"># definition of prompt for selecting tool</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a>tools_function_calling_prompt<span class="op">=</span><span class="st">&#39;Available Tools: [... {&quot;name&quot;: &quot;get_current_water_level&quot;, &quot;description&quot;: &quot;Get the current water level of a specific sensor.&quot;, &quot;parameters&quot;: {&quot;properties&quot;: {&quot;sensor_number&quot;: {&quot;description&quot;: &quot;The sensor number of which should be used to measure the water level.&quot;, &quot;type&quot;: &quot;string&quot;</span><span class="sc">}}</span><span class="st">, &quot;required&quot;: [&quot;sensor_number&quot;], &quot;type&quot;: &quot;object&quot;</span><span class="sc">}}</span><span class="st">]</span><span class="ch">\n</span><span class="st">Return an empty string if no tools match the query. If a function tool matches, construct and return a JSON object in the format {&quot;name&quot;: &quot;functionName&quot;, &quot;parameters&quot;: {&quot;requiredFunctionParamKey&quot;: &quot;requiredFunctionParamValue&quot;</span><span class="sc">}}</span><span class="st"> using the appropriate tool and its parameters. Only return the object and limit the response to the JSON object without additional text.&#39;</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a><span class="co"># réponse du modèle</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a>DEBUG [open_webui.utils.middleware] response<span class="op">=</span>{<span class="st">&#39;id&#39;</span>: <span class="st">&#39;chatcmpl-ApxUQa6si9pDCDDRYqwbr2FTj6oU4&#39;</span>, <span class="st">&#39;object&#39;</span>: <span class="st">&#39;chat.completion&#39;</span>, <span class="st">&#39;created&#39;</span>: <span class="dv">1736946770</span>, <span class="st">&#39;model&#39;</span>: <span class="st">&#39;gpt-4o-mini-2024-07-18&#39;</span>, <span class="st">&#39;choices&#39;</span>: [{<span class="st">&#39;index&#39;</span>: <span class="dv">0</span>, <span class="st">&#39;message&#39;</span>: {<span class="st">&#39;role&#39;</span>: <span class="st">&#39;assistant&#39;</span>, <span class="st">&#39;content&#39;</span>: <span class="st">&#39;{&quot;name&quot;:&quot;get_current_water_level&quot;,&quot;parameters&quot;:{&quot;sensor_number&quot;:&quot;1&quot;</span><span class="sc">}}</span><span class="st">&#39;</span>, <span class="st">&#39;refusal&#39;</span>: <span class="va">None</span>}, <span class="st">&#39;logprobs&#39;</span>: <span class="va">None</span>, <span class="st">&#39;finish_reason&#39;</span>: <span class="st">&#39;stop&#39;</span>}], <span class="st">&#39;usage&#39;</span>: {<span class="st">&#39;prompt_tokens&#39;</span>: <span class="dv">288</span>, <span class="st">&#39;completion_tokens&#39;</span>: <span class="dv">16</span>, <span class="st">&#39;total_tokens&#39;</span>: <span class="dv">304</span>, <span class="st">&#39;prompt_tokens_details&#39;</span>: {<span class="st">&#39;cached_tokens&#39;</span>: <span class="dv">0</span>, <span class="st">&#39;audio_tokens&#39;</span>: <span class="dv">0</span>}, <span class="st">&#39;completion_tokens_details&#39;</span>: {<span class="st">&#39;reasoning_tokens&#39;</span>: <span class="dv">0</span>, <span class="st">&#39;audio_tokens&#39;</span>: <span class="dv">0</span>, <span class="st">&#39;accepted_prediction_tokens&#39;</span>: <span class="dv">0</span>, <span class="st">&#39;rejected_prediction_tokens&#39;</span>: <span class="dv">0</span>}}, <span class="st">&#39;service_tier&#39;</span>: <span class="st">&#39;default&#39;</span>, <span class="st">&#39;system_fingerprint&#39;</span>: <span class="st">&#39;fp_72ed7ab54c&#39;</span>}</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true"></a><span class="co"># réponse de chatgpt-4o </span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true"></a>DEBUG [open_webui.utils.middleware] content<span class="op">=</span><span class="st">&#39;{&quot;name&quot;:&quot;get_current_water_level&quot;,&quot;parameters&quot;:{&quot;sensor_number&quot;:&quot;1&quot;</span><span class="sc">}}</span><span class="st">&#39;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true"></a><span class="co"># exécution de l&#39;outil</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true"></a>DEBUG [open_webui.utils.middleware] tool_contexts: [{<span class="st">&#39;source&#39;</span>: {<span class="st">&#39;name&#39;</span>: <span class="st">&#39;TOOL:toolbox/get_current_water_level&#39;</span>}, <span class="st">&#39;document&#39;</span>: [<span class="st">&#39;Answer in french that the current water level of sensor 1 is 1.35 mm.&#39;</span>], <span class="st">&#39;metadata&#39;</span>: [{<span class="st">&#39;source&#39;</span>: <span class="st">&#39;TOOL:toolbox/get_current_water_level&#39;</span>}]}]</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true"></a><span class="co"># gtp-4o API call</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;POST /api/chat/completions HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;GET /api/v1/chats/?page=1 HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true"></a><span class="co"># outlet definition</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true"></a>DEBUG [open_webui.routers.tasks] generating chat title using model <span class="cf">with</span><span class="op">-</span>tools <span class="cf">for</span> user francois.rioult<span class="op">@</span>unicaen.fr </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true"></a>outlet called: {<span class="st">&#39;model&#39;</span>: <span class="st">&#39;with-tools&#39;</span>, <span class="st">&#39;messages&#39;</span>: [{<span class="st">&#39;id&#39;</span>: <span class="st">&#39;4a7fca32-ea06-4e4a-8582-b7b086e87dfb&#39;</span>, <span class="st">&#39;role&#39;</span>: <span class="st">&#39;user&#39;</span>, <span class="st">&#39;content&#39;</span>: <span class="st">&#39;what is the height of the water on sensor 1?&#39;</span>, <span class="st">&#39;timestamp&#39;</span>: <span class="dv">1736946769</span>}, {<span class="st">&#39;id&#39;</span>: <span class="st">&#39;22748f3d-c6d1-4eee-9ee5-7a2d0650233d&#39;</span>, <span class="st">&#39;role&#39;</span>: <span class="st">&#39;assistant&#39;</span>, <span class="st">&#39;content&#39;</span>: <span class="st">&quot;La hauteur actuelle de l&#39;eau sur le capteur 1 est de 1,35 mm [source_id].&quot;</span>, <span class="st">&#39;timestamp&#39;</span>: <span class="dv">1736946769</span>, <span class="st">&#39;sources&#39;</span>: [{<span class="st">&#39;source&#39;</span>: {<span class="st">&#39;name&#39;</span>: <span class="st">&#39;TOOL:toolbox/get_current_water_level&#39;</span>}, <span class="st">&#39;document&#39;</span>: [<span class="st">&#39;Answer in french that the current water level of sensor 1 is 1.35 mm.&#39;</span>], <span class="st">&#39;metadata&#39;</span>: [{<span class="st">&#39;source&#39;</span>: <span class="st">&#39;TOOL:toolbox/get_current_water_level&#39;</span>}]}]}], <span class="st">&#39;chat_id&#39;</span>: <span class="st">&#39;0de06587-0cb2-4a1a-bda2-50f5d6a573e4&#39;</span>, <span class="st">&#39;session_id&#39;</span>: <span class="st">&#39;9oCTk_-_vKFrLVa0AAAB&#39;</span>, <span class="st">&#39;id&#39;</span>: <span class="st">&#39;22748f3d-c6d1-4eee-9ee5-7a2d0650233d&#39;</span>}</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;POST /api/chat/completed HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;POST /api/v1/chats/0de06587-0cb2-4a1a-bda2-50f5d6a573e4 HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;GET /api/v1/chats/?page=1 HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true"></a>DEBUG [open_webui.routers.tasks] generating chat tags using model <span class="cf">with</span><span class="op">-</span>tools <span class="cf">for</span> user francois.rioult<span class="op">@</span>unicaen.fr </span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;GET /api/v1/chats/?page=1 HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;GET /api/v1/chats/0de06587-0cb2-4a1a-bda2-50f5d6a573e4 HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true"></a>INFO:     <span class="fl">127.0.0.1</span>:<span class="dv">36306</span> <span class="op">-</span> <span class="st">&quot;GET /api/v1/chats/all/tags HTTP/1.1&quot;</span> <span class="dv">200</span> OK</span></code></pre></div>
<h2 data-number="6.3" id="dans-la-console-du-navigateur"><span class="header-section-number">6.3</span> Dans la console du navigateur</h2>
<p>Quelques traces sont disponibles. Si on filtre avec <code>sources</code>, on peut voir la réponse de l’appel de fonction, avant traitement par le modèle.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="fu">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>  <span class="dt">&quot;sources&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>    <span class="fu">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>      <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>        <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;TOOL:toolbox/get_current_water_level&quot;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a>      <span class="fu">},</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a>      <span class="dt">&quot;document&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a>        <span class="st">&quot;Answer in french that the current water level of sensor 1 is 1.35 mm.&quot;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a>      <span class="dt">&quot;metadata&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a>        <span class="fu">{</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a>          <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="st">&quot;TOOL:toolbox/get_current_water_level&quot;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a>        <span class="fu">}</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a>      <span class="ot">]</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a>    <span class="fu">}</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a>  <span class="ot">]</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a><span class="fu">}</span></span></code></pre></div>
<h1 data-number="7" id="conclusion"><span class="header-section-number">7</span> Conclusion</h1>
<h2 data-number="7.1" id="leçons"><span class="header-section-number">7.1</span> Leçons</h2>
<p><code>Open-webui</code> offre la promesse de concurrencer les ChatGPT-plus Actions, qui broutent une documentation, génèrent une spécification, effectuent l’appel API et fournissent le résultat. Les deux ne proposent pas de cadre de développement rigoureux, avec gestion des sources et log. Mais au moins avec <code>Open-webui</code> on peut bricoler !</p>
<p>Il faut garder en tête que :</p>
<ul>
<li>le prompt est soumis au modèle avec la description des outils, pour choisir le bon</li>
<li>l’appel de fonction Python est exécuté selon les instructions du modèle</li>
<li>le résultat de l’appel de fonctions est traité par le modèle</li>
</ul>
<h1 data-number="8" id="questions"><span class="header-section-number">8</span> Questions</h1>
<ul>
<li>est-il possible de faire mieux ?
<ul>
<li>comment générer des logs dans l’outil ?</li>
<li>les logs sont-ils stockés quelque part ? Analyser la sortie du serveur est peu pratique.</li>
</ul></li>
<li>pourrait-on décorréler les deux appels LLM choix outil / formulation de réponse ?</li>
<li>pourrait-on forcer le premier appel de choix d’outil avec API standard ?</li>
</ul>
<h1 data-number="9" id="pensée"><span class="header-section-number">9</span> Pensée</h1>
<p>J’ai lu hier que <code>Open-webui</code> est l’<a href="https://www.reddit.com/r/OpenWebUI/comments/1gjziqm/im_the_sole_maintainer_of_open_webui_ama/">oeuvre d’un seul homme</a>. Respect !</p>
<p>Malgré ses défauts en terme de diagnostique, cela fonctionne quasi parfaitement.</p>
<p>Si c’est l’oeuvre d’un seul homme, un seul homme peut lire le code et l’améliorer ?</p>
<h1 data-number="10" id="sources"><span class="header-section-number">10</span> Sources</h1>
<ul>
<li><a href="https://github.com/open-webui/open-webui/discussions/3134#discussioncomment-10796319">code for water height on sensors</a></li>
<li><a href="https://github.com/open-webui/open-webui/discussions/3134#discussioncomment-11218580">précisions sur les outils</a></li>
<li><a href="https://github.com/open-webui/open-webui/pull/6836">détails sur les possibilités d’appel de fonction</a></li>
</ul>
<pre><code>(&quot;what is the first letter of the latin alphabet&quot;,  &quot;no tools needed&quot;),
(&quot;what is the date of today (use the get_current_time function)&quot;, &quot; 1 tool no args&quot;),
(&quot;what is the value of sensor 1&quot;, &quot; 1 tool with args&quot;),
(&quot;what are the value of sensors 1 and 4&quot;, &quot; 2 tools (the may be run in parallel if the API supports it )&quot;),
(&quot;if the value of sensors 1 is less that 5 m/s report the value of sensor 4. Otherwise report sensor 3&quot;, &quot; 2 tools (in s
equence if the model does it )&quot;),
(&quot;choose a integer between 1 an 10 write it here. If it&#39;s bigger that 5 report sensor 4. Otherwise report sensor 1&quot;, &quot; tool call after having generated some text&quot;),
(&quot;what is the value of sensor &#39;HELLO&#39; &quot;,  &quot;tool call raises an exception&quot;)</code></pre>
</body>
</html>
