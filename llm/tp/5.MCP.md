---
author:
- François Rioult
lang: fr
title: Application des LLM 
subtitle: TP : MCP
---

***Toutes les manipulations doivent être exécutées en terminal, dans l'environnement `uv` qui donne accès à la commande `mcp`.


On met en oeuvre MCP avec `AnythingLLM` :

Le fichier `~/.config/anythingllm-desktop/storage/plugins/anythingllm_mcp_servers.json` contient la liste des services MCP :

```json
{
  "mcpServers": {
      "time": {
          "command": "uvx",
          "args": [
              "mcp-server-time",
              "--local-timezone=America/New_York"
          ]
      },
      "memory": {
          "command": "npx",
          "args": [
              "-y",
              "@modelcontextprotocol/server-memory"
          ]
      },
      "mcp": {
          "command": "mcp",
          "args": [
              "run",
              "mcp-server-demo.py"
          ]
      }
  }
}
```

# Pré-recquis

* installer `uv`, le gestionnaire d'environnement pour `python`
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
source $HOME/.local/bin/env
```

# Serveur MCP

* configurer l'environnement :

```bash
# initialisation répertoire
uv init mcp-server-demo
cd mcp-server-demo/
# création environnement
uv add "mcp[cli]"
# activer l'environnement
source .venv/bin/activate
```

* configurer le serveur, dans [config.json](script/mcp-server-demo/config.json)

```json
{
    "mcpServers": {
        "time": {
            "command": "uvx",
            "args": [
                "mcp-server-time",
                "--local-timezone=America/New_York"
            ]
        },
        "memory": {
            "command": "npx",
            "args": [
                "-y",
                "@modelcontextprotocol/server-memory"
            ]
        },
        "mcp": {
            "command": "mcp",
            "args": [
                "run",
                "mcp-server-demo.py"
            ]
        }
    }
}
```

* on constate l'utilisation de trois technologies :

  1. `uvx`
  1. `node`
  1. `mcp` : met à disposition du code `python`

* on voit ici deux outils et un template de message : définir le code du serveur dans [`mcp-server-demo.py`](script/mcp-server-demo/) :

```python
# server.py
from mcp.server.fastmcp import FastMCP

# Create an MCP server
mcp = FastMCP("Demo")

# Add an addition tool
@mcp.tool()
def add(a: int, b: int) -> int:
    """Add two numbers"""
    return a + b

@mcp.tool()
def level(sensor: int) -> str:
    """Returns the level at given sensor"""
    if sensor == 1:
        return {"level":10.0}
    return {"level":24.0}

# Add a dynamic greeting resource
@mcp.resource("greeting://{name}")
def get_greeting(name: str) -> str:
    """Get a personalized greeting"""
    return f"Hello, {name}!"
```

* exécuter le serveur

        mcp dev mcp-server-demo.py


Le navigateur ouvre la page <http://127.0.0.1:6274> qui permet de tester le serveur. Une fois connecté, on peut tester les outils à l'aide de formulaires.

## Intégration `AnythingLLM`

**The server has to be launched in the correct environment.**

Pour une installation initiale de `AnuthingLLM` :

* se positionner dans le répertoire contenant le code des outils

        uv sync
        source .venv/bin/activate
        # informer AnythingLLM des serveurs MCP
        cp config.json ~/.config/anythingllm-desktop/storage/plugins/anythingllm_mcp_servers.json 

* tester que l'environnement est en place :

        mcp dev mcp-server-demo.py

* lancer `AnythingLLM`

        ~/software/AnythingLLMDesktop.AppImage --no-sandbox

* générer une clé d'API

SB2H54Q-B1T4P3Z-NE8EGVE-66WF5C7

* afficher la documentation `swagger` de l'API

  * cliquer sur `Authorize`
  * fournir la clé d'API
  * exécuter la requête d'uathentication

```bash
curl -X 'GET' \
  'http://localhost:3001/api/v1/auth' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer SB2H54Q-B1T4P3Z-NE8EGVE-66WF5C7'
  ```

  * pour accéder à l'interface d'appel des outils :
<http://localhost:3001/api/docs/#/Workspaces/post_v1_workspace__slug__chat>
  * `Try it out`
  * définir le *slug* : c'est le nom de l'environnement

  * définir le body :

```json
{
  "message": "@agent what is level on sensor 1? If you dont know, just answer I dont know /exit",
  "mode": "chat",
  "sessionId": "identifier-to-partition-chats-by-external-id",
  "reset": false
}
```




```json
{
  "id": "f38d3342-67fd-4a88-b5bf-429df86e3c9e",
  "type": "textResponse",
  "sources": [],
  "close": true,
  "error": null,
  "textResponse": "I don't know. /exit",
  "thoughts": [
    "@agent is executing `mcp-level` tool {\n  \"sensor\": 1\n}",
    "Executing MCP server: mcp with {\n  \"sensor\": 1\n}",
    "MCP server: mcp:level completed successfully"
  ]
}
```

On vérifiera qu'on peut exécuter la requête `swagger` dans un terminal :
```bash
curl -X 'POST' \
  'http://localhost:3001/api/v1/workspace/unicaen/chat' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer SB2H54Q-B1T4P3Z-NE8EGVE-66WF5C7' \
  -H 'Content-Type: application/json' \
  -d '{
  "message": "@agent what is level on sensor 1? If you dont know, just answer I dont know /exit",
  "mode": "chat",
  "sessionId": "identifier-to-partition-chats-by-external-id",
  "reset": false
}'```


# Limites

Actuellement, l'outil ne fonctionne pas sur la VDI, quand on le lance par `mcp dev ...`.